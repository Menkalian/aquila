serverBuild:
  stage: application-build
  script:
    - cd aquila-server
    - gradle publishToMavenLocal
  cache:
    key: aquila-server
    paths:
      - aquila-server/.gradle
  except:
    changes:
      - aquila-app/*/version.properties
  artifacts:
    paths:
      - aquila-server/build
    expire_in: 1 week

serverTest:
  stage: application-test
  script:
    - cd aquila-server
    - gradle test
  cache:
    key: aquila-server
    paths:
      - aquila-server/.gradle
  except:
    changes:
      - aquila-app/*/version.properties

serverPublish:
  stage: application-deploy
  only:
    - main
  script:
    - cd aquila-server
    - gradle publish
  cache:
    key: aquila-server
    paths:
      - aquila-server/.gradle
  except:
    changes:
      - aquila-app/*/version.properties
  artifacts:
    paths:
      - aquila-server/build/libs/*.jar
    expire_in: 1 month

serverDockerDeploy:
  stage: application-deploy
  only:
    - main
  image: docker:20
  script:
    - cd aquila-server
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.gitlab.com
    - docker build -t registry.gitlab.com/kiliankra/aquila/server:latest .
    - docker push registry.gitlab.com/kiliankra/aquila/server:latest
  except:
    changes:
      - aquila-app/*/version.properties

serverRollout:
  stage: application-rollout
  only:
    - main
  image: ubuntu:xenial
  script:
    - apt-get update
    - apt-get install -y ssh
    - chmod u=r,go=- $SSH_KEY
    - ssh -i $SSH_KEY -oStrictHostKeyChecking=no aquila@server.menkalian.de /home/aquila/aquila/restartServer.sh
  except:
    changes:
      - aquila-app/*/version.properties