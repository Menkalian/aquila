appsBuild:
  stage: application-build
  image: jangrewe/gitlab-ci-android
  script:
    - cd aquila-app
    - chmod +x ./gradlew
    - ./gradlew assemble
  cache:
    key: aquila-app
    paths:
      - aquila-app/.gradle
      - /root/.gradle/
  except:
    changes:
      - aquila-app/*/version.properties
  artifacts:
    paths:
      - aquila-app/build
      - aquila-app/*/build
    expire_in: 1 week

appsTest:
  stage: application-test
  image: jangrewe/gitlab-ci-android
  script:
    - cd aquila-app
    - chmod +x ./gradlew
    - ./gradlew test
  cache:
    key: aquila-app
    paths:
      - aquila-app/.gradle
      - /root/.gradle/
  except:
    changes:
      - aquila-app/*/version.properties

appsPublish:
  stage: application-deploy
  image: jangrewe/gitlab-ci-android
  only:
    - main
  script:
    - cd aquila-app
    - chmod +x ./gradlew
    - ./gradlew assemble signReleaseBundle publish
  after_script:
    - git remote set-url origin https://${GITLAB_USER_LOGIN}:${GIT_TOKEN}@gitlab.com/kiliankra/aquila.git
    - git config --global user.email ${GITLAB_USER_EMAIL}
    - git config --global user.name ${GITLAB_USER_NAME}
    - git checkout -B main
    - git add aquila-app/app-android/version.properties
    - git add aquila-app/app-loader/version.properties
    - git add aquila-app/app-wear/version.properties
    - git commit -m "Update Release Version -- CI"
    - git push -u origin main
  cache:
    key: aquila-app
    paths:
      - aquila-app/.gradle
      - /root/.gradle/
  except:
    changes:
      - aquila-app/*/version.properties
  artifacts:
    paths:
      - aquila-app/*/build/outputs/apk/debug/*.apk
      - aquila-app/*/build/outputs/apk/release/*.apk
    expire_in: 1 month